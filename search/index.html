<!DOCTYPE html5>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Flatstat | Stats from flathub.org</title>
    <link rel="stylesheet" type="text/css" href="../index.css"></link>
    <link rel="stylesheet" type="text/css" href="./search.css"></link>
</head>
  <body>
    <header>
      <a href="/flatstat/"><h1 id="title" title="Flatstat | Stats from flathub.org">flatstat</h1></a>
      <nav>
        <a href="/flatstat/#" title="Graphs">graph</a>
        <a href="/flatstat/search/?filter=x11-only" title="Search">search</a>
      </nav>
    </header>
    <main>
      <nav>
        <a id="x11-only" title="Apps only supporting x11" href="/flatstat/search/?filter=x11-only">--x11 only</a>
        <a id="filesystem-home" title="Apps with --filesystem=home enabled" href="/flatstat/search/?filter=filesystem-home">--filesystem=home</a>
        <a id="filesystem-host" title="Apps with --filesystem=host enabled" href="/flatstat/search/?filter=filesystem-host">--filesystem=host</a>
        <a id="device-all" title="Apps with --device=all enabled" href="/flatstat/search/?filter=device-all">--device=all</a>
      </nav>
      <ul>
      </ul>
    </main>
  </body>
  <script type="module">
    import metadata from "../db/flathub/metadata.js"

    const urlParams = new URLSearchParams(window.location.search);
    const ul = document.querySelector("ul")
    const filter = urlParams.get("filter");
    
    // Check if any a[href] contains the search, and mark them as active
    let searchLink = document.querySelector(`header a[href*='/search']`)
    searchLink?.classList.add("current")

    let currentFilterLink = document.getElementById(filter??"unknown")
    currentFilterLink?.classList.add("current")

    let filtered = null;
    switch(filter) {
      case "filesystem-host":
        filtered = metadata.filter(it => it.history[0]?.filesystemHost)
        break;
      case "filesystem-home":
        filtered = metadata.filter(it => it.history[0]?.filesystemHome)
        break;
      case "x11-only":
        filtered = metadata.filter(it => (it.history[0]?.x11 || it.history[0]?.fallbackX11) && !it.history[0]?.wayland)
        break;
      case "device-all":
        filtered = metadata.filter(it => (it.history[0]?.deviceAll))
        break;
    }



    ul.innerHTML = filtered ? filtered
    .sort((a,b) => {
      if (b.stargazerCount === a.stargazerCount) {
        return a.name.localeCompare(b.name)
      } else {
        return (b.stargazerCount - a.stargazerCount)
      }
    })
    .map(({name, ext, branch,stargazerCount }) => {
      const href = `https://github.com/flathub/${name}/blob/${branch}/${name}.${ext}` 
    
      return  `<a 
        href="${href}" 
        title="${href}" 
        target="_blank"
      >
          <span>${name}.${ext}</span>
          <span title="${stargazerCount} Github stars">${stargazerCount ? (stargazerCount + " ‚≠ê") : ""}</span>
      </a>
`;
    }
    ).join("") : "No filter selected"
  </script>
</html>
