<!DOCTYPE html5>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Flatstat | Stats from flathub.org</title>
    <link rel="stylesheet" type="text/css" href="../index.css"></link>
    <link rel="stylesheet" type="text/css" href="./search.css"></link>
</head>
  <body>
    <header>
      <a href="/flatstat/"><h1 id="title" title="Flatstat | Stats from flathub.org">flatstat</h1></a>
      <nav>
        <a href="/flatstat/#display" title="Graphs">graph</a>
        <a href="/flatstat/search/?filter=x11-only" title="Search">search</a>
        <a href="/flatstat/about/" title="About">about</a>
      </nav>
    </header>
    <main>
      <nav>
        <a id="x11-only" title="Apps only supporting x11" href="/flatstat/search/?filter=x11-only">--x11 only</a>
        <a id="filesystem-home" title="Apps with --filesystem=home enabled" href="/flatstat/search/?filter=filesystem-home">--filesystem=home</a>
        <a id="filesystem-host" title="Apps with --filesystem=host enabled" href="/flatstat/search/?filter=filesystem-host">--filesystem=host</a>
        <a id="device-all" title="Apps with --device=all enabled" href="/flatstat/search/?filter=device-all">--device=all</a>
      </nav>
      <ul>
      </ul>
    </main>
  </body>
  <script type="module">
    import metafiles from "../db/flathub/metafiles.js"

    const urlParams = new URLSearchParams(window.location.search);
    const ul = document.querySelector("ul")
    const filter = urlParams.get("filter");
    
    // Check if any a[href] contains the search, and mark them as active
    let searchLink = document.querySelector(`header a[href*='/search']`)
    searchLink?.classList.add("current")

    let currentFilterLink = document.getElementById(filter??"unknown")
    currentFilterLink?.classList.add("current")

    let filtered = null;
    switch(filter) {
      case "filesystem-host":
        filtered = metafiles.filter(it => it.history[0]?.finishArgs?.filesystem?.includes("host"))
        break;
      case "filesystem-home":
        filtered = metafiles.filter(it => it.history[0]?.finishArgs?.filesystem?.includes("home"))
        break;
      case "x11-only":
        filtered = metafiles.filter(it => {
          const socket = it.history[0]?.finishArgs?.socket;
          return (!!socket?.includes("x11") || !!socket?.includes("fallback-x11")) && !socket?.includes("wayland")
        })
        break;
      case "device-all":
        filtered = metafiles.filter(it => it.history[0]?.finishArgs?.device?.includes("all"))
        break;
    }



    ul.innerHTML = filtered ? filtered
      .sort((a,b) => {
        if (b.stargazerCount === a.stargazerCount) {
          return a.appID.localeCompare(b.appID)
        } else {
          return (b.stargazerCount - a.stargazerCount)
        }
      })
      .map(({appID, ext, branch, stargazerCount }) => {
        const href = `https://github.com/flathub/${appID}/blob/${branch}/${appID}.${ext}` 
        
        return  `<a 
          href="${href}" 
          title="Open file on Github"
          target="_blank"
        >
            <span>${appID}.${ext}</span>
            <span title="${stargazerCount} Github stars">${stargazerCount ? (stargazerCount + " ‚≠ê") : ""}</span>
        </a>
  `;
      }
      ).join("") : "No filter selected"
  </script>
</html>
