<!DOCTYPE html5>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Flatstat | List</title>
    <link rel="stylesheet" type="text/css" href="../index.css"></link>
    <link rel="stylesheet" type="text/css" href="./list.css"></link>
</head>
  <body>
    <header>
      <a href="/"><h1 id="title" title="Flatstat | List">flatstat</h1></a>
      <nav>
        <a href="/" title="Graphs">graph</a>
        <a href=/list/ title="Lists">list</a>
        <a href="/achievements/" title="Achievements">achievements</a>
        <a href="/about/" title="About">about</a>
      </nav>
    </header>
    <main>
      <nav>
        <a id="#achievements" title="Apps ranked by number of achievements" href="/list/#achievements">🏅 achievements</a>
        <a id="#holes" title="Apps ranked by number of holes" href="/list/#holes">💥 holes</a>
        <a id="#stars" title="Apps ranked by number of Github stars" href="/list/#stars">⭐ stars</a>
      </nav>
      <ul>
      </ul>
    </main>
  </body>
  <script type="module">
    import metafiles from "../db/flathub/metafiles.js"
    import { addAchievements, addHoles, countAchievements, countHoles } from "../src/achievements.js";


    // Check if any a[href] contains the search, and mark them as active
    let searchLink = document.querySelector(`header a[href*='/list']`)
    searchLink?.classList.add("current")

    // Set current active button
    const graphLink = document.getElementById(window.location.hash)
    if (graphLink) {
      graphLink.classList.add("current")
    } else {
      document.getElementById("#achievements").classList.add("current");
    }

    renderList();
    window.addEventListener("hashchange", () => {
      const links = document.querySelectorAll("main nav a")
      for (const link of links) link.classList.remove("current")

      const graphLink = document.getElementById(window.location.hash)
      graphLink?.classList.add("current")
      renderList();
    })

    // Map, filter, reduce list
    function renderList() {
      const ul = document.querySelector("ul")
      const LIST_LIMIT = 1000;

      const metafileWithCounts = metafiles
        

      let counted = [];
      switch(window.location.hash) {
        case "#stars":
          counted = metafileWithCounts
            .map(it => ({
              ...it,
              icon: "⭐",
              count: it.stargazerCount,
              title: `${it.stargazerCount} Github stars`
            }))
          break;
        case "#holes":
          counted = metafileWithCounts
            .filter(it => it.history[0]?.finishArgs)  
            .map(it => ({
              ...it,
              holes: addHoles(it.history[0].finishArgs)
            }))
            .map(it => ({
              ...it,
              icon: "💥",
              count: countHoles(it.holes),
              title: Object.keys(it.holes).join(", ")
            }))
          break;
        default: /* achievements */
          counted = metafileWithCounts
            .filter(it => it.history[0]?.finishArgs)  
            .map(it => ({
              ...it,
              achievements: addAchievements(it.history[0].finishArgs),
            }))
            .map(it => ({
              ...it,
              icon: "🏅",
              count: countAchievements(it.achievements),
              title: Object.keys(it.achievements).join(", ")
            }))
          break;
      }

      ul.innerHTML = counted
        .sort((a, b) => b.count - a.count)
        .slice(0, LIST_LIMIT)
        .map(({ appID, ext, branch, count, icon, max, title }) => {
          const href = `https://github.com/flathub/${appID}/blob/${branch}/${appID}.${ext}` 
          
          return  `\
  <a 
    href="${href}" 
    title="${title}"
    target="_blank"
  >
    <span>${appID}.${ext}</span>
    <span>${count ? (count + ` ${icon}`) : ""}</span>
  </a>
  `;
        }).join("");

      }


  </script>
</html>
