<!DOCTYPE html5>
<html>

<head>
  <meta charset="utf-8" />
  <title>Flatstat | List</title>
  <link rel="stylesheet" type="text/css" href="../index.css">
  </link>
  <link rel="stylesheet" type="text/css" href="./index.css">
  </link>
</head>

<body>
  <header>
    <a href="/">
      <h1 id="title" title="Flatstat | List">flatstat</h1>
    </a>
    <nav>
      <a href="/" title="Graphs">graphs</a>
      <a href=/lists/ title="Lists" class="active">lists</a>
      <a href="/library/" title="Library">library</a>
      <a href="/about/" title="About">about</a>
    </nav>
  </header>
  <main>
    <nav>
      <a id="#achievements" title="Apps sorted by achievements" href="/lists/#achievements">ğŸ… achievements</a>
      <a id="#holes" title="Apps sorted by holes" href="/lists/#holes">ğŸ’¥ holes</a>
      <a id="#portals" title="Apps sorted by portals" href="/lists/#portals">ğŸ•³ï¸ portals</a>
      <a id="#stars" title="Apps sorted by Github stars" href="/lists/#stars">â­ stars</a>
    </nav>
    <ul>
    </ul>
  </main>
</body>
<script type="module">
  import { incrementAchievementCount, incrementHoleCount, incrementPortalCount, sumAchievements, sumHoles, sumPortals } from "../lib/stats.js";
  import { useJSON } from "../lib/useJSON.js";
  import { useActiveLink } from "../lib/useActiveLink.js";

  useActiveLink("#achievements")

  renderList();
  window.addEventListener("hashchange", renderList)


  // Map, filter, sort, slice, join list
  async function renderList() {
    const metafiles = await useJSON("../data/flathub/metafiles.json")

    const ul = document.querySelector("ul")
    const LIST_LIMIT = 1000;

    let list = [];
    switch (window.location.hash) {
      case "#stars":
        list = metafiles
          .map(it => ({
            ...it,
            icon: "â­",
            count: it.stargazerCount,
            title: `${it.stargazerCount} Github stars`,
            details: ""
          }))
        break;
      case "#holes":
        list = metafiles
          .filter(it => it.history[0]?.finishArgs)
          .map(it => ({
            ...it,
            holes: incrementHoleCount(it.history[0].finishArgs)
          }))
          .map(it => ({
            ...it,
            icon: "ğŸ’¥",
            count: sumHoles(it.holes),
            title: Object.keys(it.holes).join("&#010;"),
            details: Object.keys(it.holes).join(", ")
          }))
        break;
      case "#portals":
        list = metafiles
          .filter(it => it.history[0]?.finishArgs)
          .map(it => ({
            ...it,
            portals: incrementPortalCount(it.history[0].finishArgs)
          }))
          .map(it => ({
            ...it,
            icon: "ğŸ•³ï¸",
            count: sumPortals(it.portals),
            title: Object.keys(it.portals).join("&#010;"),
            details: Object.keys(it.portals).join(", ")
          }))
        break;
      default: /* achievements */
        list = metafiles
          .filter(it => it.history[0]?.finishArgs)
          .map(it => ({
            ...it,
            achievements: incrementAchievementCount(it.history[0].finishArgs),
          }))
          .map(it => ({
            ...it,
            icon: "ğŸ…",
            count: sumAchievements(it.achievements),
            title: Object.keys(it.achievements).join("&#010;"),
            details: Object.keys(it.achievements).join(", ")
          }))
        break;
    }

    ul.innerHTML = list
      .filter(it => it.count)
      .sort((a, b) => b.count - a.count)
      .slice(0, LIST_LIMIT)
      .map(({ appID, ext, count, icon, title, details, displayURL }) => {

        return `\
  <a
    href="${displayURL}"
    title="${title}"
    target="_blank"
  >
    <span class="left">${appID}.${ext}</span>
    <span class="middle"> ${details}</span>
    <span class="padding"></span>
    <span>${count ? (count + ` ${icon}`) : ""}</span>
  </a >
  `;
      }).join("");

  }


</script>

</html>