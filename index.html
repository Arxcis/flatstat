<!DOCTYPE html5>
<html>

<head>
  <meta charset="utf-8" />
  <title>Flatstat | Lists</title>
  <link rel="stylesheet" type="text/css" href="./index.css">
  </link>
</head>

<body>
  <header>
    <a href="/">
      <h1 id="title" title="Flatstat | Lists">flatstat</h1>
    </a>
    <nav>
      <a href="/" title="Lists" class="active">lists</a>
      <a href=/graphs/ title="Graphs">graphs</a>
      <a href="/library/" title="Library">library</a>
      <a href="/about/" title="About">about</a>
    </nav>
  </header>
  <main>
    <input id="search" value="" type="search" placeholder="Search for name">
    <nav>
      <a id="#finish-args" title="Frequently used finish-args" href="/#finish-args">🏁 finish-args</a>
      <a id="#achievements" title="Apps sorted by achievement count" href="/#achievements">🏅 achievements</a>
      <a id="#holes" title="Apps sorted by hole count" href="/#holes">💥 holes</a>
      <a id="#portals" title="Apps sorted by --talk-name count" href="/#portals">🕳️ portals</a>
      <a id="#stars" title="Apps sorted by Github stars count" href="/#stars">⭐ stars</a>
    </nav>
    <ul>
    </ul>
  </main>
</body>
<script type="module">
  import { incrementAchievementCount, incrementHoleCount, incrementPortalCount, sumAchievements, sumHoles, sumPortals } from "./lib/stats.js";
  import { useJSON } from "./lib/useJSON.js";
  import { useActiveLink } from "./lib/useActiveLink.js";
  import { useSearch } from "./lib/useSearch.js";

  let fetching = true;
  let count = [];
  let metafiles = [];

  useActiveLink("#finish-args")
  const input = useSearch("#search", (search) => renderList(search))

  renderList(input.value);
  window.addEventListener("hashchange", () => renderList(input.value))

  // Map, filter, sort, slice, join list
  async function renderList(search = "") {
    if (fetching) {
      count = await useJSON("./data/flathub/count.json")
      metafiles = await useJSON("./data/flathub/metafiles.json")
      fetching = false;
    }

    const ul = document.querySelector("ul")
    const LIST_LIMIT = 1000;

    let list = [];
    switch (window.location.hash) {
      case "#stars":
        list = metafiles
          .map(it => ({
            count: it.stargazerCount,
            details: "",
            displayURL: it.displayURL,
            icon: "⭐",
            name: `${it.appID}.${it.ext}`,
            title: `${it.stargazerCount} Github stars`,
          }))
        break;
      case "#holes":
        list = metafiles
          .filter(it => it.history[0]?.finishArgs)
          .map(it => ({
            ...it,
            holes: incrementHoleCount(it.history[0].finishArgs)
          }))
          .map(it => ({
            count: sumHoles(it.holes),
            details: Object.keys(it.holes).join(", "),
            displayURL: it.displayURL,
            icon: "💥",
            name: `${it.appID}.${it.ext}`,
            title: Object.keys(it.holes).join("&#010;"),
          }))
        break;
      case "#portals":
        list = metafiles
          .filter(it => it.history[0]?.finishArgs)
          .map(it => ({
            ...it,
            portals: incrementPortalCount(it.history[0].finishArgs)
          }))
          .map(it => ({
            count: sumPortals(it.portals),
            details: Object.keys(it.portals).join(", "),
            displayURL: it.displayURL,
            icon: "🕳️",
            name: `${it.appID}.${it.ext}`,
            title: Object.keys(it.portals).join("&#010;"),
          }))
        break;
      case "#achievements":
        list = metafiles
          .filter(it => it.history[0]?.finishArgs)
          .map(it => ({
            ...it,
            achievements: incrementAchievementCount(it.history[0].finishArgs),
          }))
          .map(it => ({
            count: sumAchievements(it.achievements),
            details: Object.keys(it.achievements).join(", "),
            displayURL: it.displayURL,
            icon: "🏅",
            name: `${it.appID}.${it.ext}`,
            title: Object.keys(it.achievements).join("&#010;"),
          }))
        break;
      default: /* finish-args */
        list = Object.entries(count[count.length - 1].finishArgs).map(([arg, count]) => ({
          count,
          details: "",
          displayURL: null,
          icon: "🏁",
          name: arg,
          title: `${arg} - used by ${count} apps`,
        }))
        break;
    }

    ul.innerHTML = list
      .filter(it => it.count)
      // search
      .filter(it => it.name.toLowerCase().includes(search.toLowerCase()))
      .sort((a, b) => b.count - a.count)
      .slice(0, LIST_LIMIT)
      .map(({ count, details, displayURL, icon, name, title }) => {

        return `\
  <${displayURL ? "a" : "div"}
    class="row"
    href="${displayURL}"
    title="${title}"
    target="_blank"
  >
    <span class="left">${name}</span>
    <span class="middle"> ${details}</span>
    <span class="padding"></span>
    <span>${count ? (count + ` ${icon}`) : ""}</span>
  </${displayURL ? "a" : "div"}>
  `;
      }).join("");

  }


</script>

</html>
