<!DOCTYPE html5>
<html>

<head>
  <meta charset="utf-8" />
  <title>Flatstat | Lists</title>
  <link rel="stylesheet" type="text/css" href="./index.css">
  </link>
</head>

<body>
  <header>
    <a href="/flatstat/">
      <h1 id="title" title="Flatstat | Lists">flatstat</h1>
    </a>
    <nav>
      <a href="/flatstat/" title="Lists" class="active">lists</a>
      <a href="/flatstat/graphs/" title="Graphs">graphs</a>
      <a href="/flatstat/library/" title="Library">library</a>
      <a href="/flatstat/about/" title="About">about</a>
    </nav>
  </header>
  <main>
    <input id="search" value="" type="search" placeholder="Search for name">
    <nav>
      <a id="#apps" title="Apps sorted by Github stars" href="/flatstat/#apps">ğŸ•¹ï¸ apps</a>
      <a id="#changelog" title="Latest changes" href=" /#changelog">ğŸ“œ changelog</a>
      <a id="#finish-args" title="Frequently used 'finish-args'" href=" /#finish-args">ğŸ finish-args</a>
      <a id="#achievements" title="Apps sorted by achievements" href="/flatstat/#achievements">ğŸ… achievements</a>
      <a id="#holes" title="Apps sorted by holes" href="/flatstat/#holes">ğŸ’¥ holes</a>
      <a id="#portals" title="Apps sorted by well-known portals" href="/flatstat/#portals">ğŸ•³ï¸ portals</a>
    </nav>
    <ul>
    </ul>
    <footer>Showing 0 results</footer>
  </main>
</body>
<script type="module">
  import {
    incrementAchievementCount,
    incrementHoleCount,
    incrementPortalCount,
    incrementFinishArgs,
    sumFinishArgs,
    sumAchievements,
    sumHoles,
    sumPortals
  } from "./lib/stats.js";
  import { useJSON } from "./lib/useJSON.js";
  import { useActiveLink } from "./lib/useActiveLink.js";
  import { useSearch } from "./lib/useSearch.js";
  import { useMarkPerformance, useMeasurePerformance } from "./lib/usePerformance.js";


  // Setup rendering triggers
  useActiveLink("#apps")
  const input = useSearch("#search", (search) => renderList(search, window.location.hash))

  window.addEventListener("hashchange", () => renderList(input.value, window.location.hash))


  // Init search indexes
  let changelogIndex = [];
  let holesIndex = [];
  let portalsIndex = [];
  let achievementsIndex = [];
  let appsIndex = [];
  let finishArgsIndex = [];

  buildSearchIndexes();

  // Build optimized search datastructures based on the rawdata
  async function buildSearchIndexes() {
    const count = await useJSON("./data/flathub/count.json")
    const metafiles = await useJSON("./data/flathub/metafiles.json")
    const changelog = await useJSON("./data/flathub/changelog.json")

    // changelog
    changelogIndex = changelog
      .reduce((acc, { appID, ext, displayURL, date, additions, deletions, created }) => {
        const count = `&#010;${date.slice(0, 10)}`;

        if (created) {
          const tags = [`New app ${appID}.${ext}&#010;`, ...created, count];
          acc.push({
            name: `ğŸ•¹ï¸ ${appID}`,
            displayURL,
            count,
            icon: "",
            details: created.join(", "),
            tags,
            searchString: tags.join("").toLocaleLowerCase()
          });
        }

        if (additions) {
          const tags = [`Additions in ${appID}.${ext}&#010;`, ...additions, count];
          acc.push({
            name: `â• ${additions.join(", ")}`,
            displayURL,
            count,
            icon: "",
            details: appID,
            tags,
            searchString: tags.join("").toLocaleLowerCase()
          });
        }

        if (deletions) {
          const tags = [`Deletions in ${appID}.${ext}&#010;`, ...deletions, count];
          acc.push({
            name: `â– ${deletions.join(", ")}`,
            displayURL,
            count,
            icon: "",
            details: appID,
            tags,
            seachString: tags.join("").toLocaleLowerCase()
          })
        }

        return acc;
      }, [])
      .sort((a, b) => b.count.localeCompare(a.count))


    // holes
    holesIndex = metafiles
      .filter(it => it.history[0]?.finishArgs)
      .map(it => {
        const holes = incrementHoleCount(it.history[0].finishArgs)
        const count = sumHoles(holes);
        const tags = [`${it.appID}.${it.ext}`, ...Object.keys(holes)];

        return {
          count,
          displayURL: it.displayURL,
          icon: "ğŸ’¥",
          name: `ğŸ•¹ï¸ ${it.appID}.${it.ext}`,
          tags,
          searchString: tags.join(" ").toLocaleLowerCase(),
        }
      })
      .sort((a, b) => b.count - a.count)

    // portals
    portalsIndex = metafiles
      .filter(it => it.history[0]?.finishArgs)
      .map(it => {
        const portals = incrementPortalCount(it.history[0].finishArgs)
        const count = sumPortals(portals);
        const tags = [`${it.appID}.${it.ext}`, ...Object.keys(portals)];

        return {
          count,
          displayURL: it.displayURL,
          icon: "ğŸ•³ï¸",
          name: `ğŸ•¹ï¸ ${it.appID}.${it.ext}`,
          tags,
          searchString: tags.join("").toLocaleLowerCase(),
        }
      })
      .sort((a, b) => b.count - a.count)

    // achievements
    achievementsIndex = metafiles
      .filter(it => it.history[0]?.finishArgs)
      .map(it => {
        const achievements = incrementAchievementCount(it.history[0].finishArgs);
        const count = sumAchievements(achievements);
        const tags = [`${it.appID}.${it.ext}`, ...Object.keys(achievements)];

        return {
          count,
          displayURL: it.displayURL,
          icon: "ğŸ…",
          name: `ğŸ•¹ï¸ ${it.appID}.${it.ext}`,
          tags,
          searchString: tags.join("").toLocaleLowerCase(),
        }
      })
      .sort((a, b) => b.count - a.count)

    // finishArgs
    finishArgsIndex = Object.entries(count[count.length - 1].finishArgs).map(([arg, count]) => {
      const tags = [arg]

      return {
        title: `${arg} - used by ${count} apps`,
        count,
        displayURL: null,
        icon: "",
        name: `ğŸ ${arg}`,
        tags,
        searchString: tags.join("").toLocaleLowerCase(),
      }
    })
      .sort((a, b) => b.count - a.count)

    // apps
    appsIndex = metafiles
      .map(it => {
        const finishArgs = incrementFinishArgs(it.history[0]?.finishArgs ?? [])
        const tags = [`${it.appID}.${it.ext}`, ...(finishArgs ? Object.keys(finishArgs) : [])];

        return {
          count: it.stargazerCount,
          displayURL: it.displayURL,
          icon: "â­",
          name: `ğŸ•¹ï¸ ${it.appID}.${it.ext}`,
          tags,
          searchString: tags.join("").toLocaleLowerCase(),
        }
      })
      .sort((a, b) => b.count - a.count)

    renderList(input.value, window.location.hash);
  }

  // Render Map, filter, sort, slice, join list
  async function renderList(search, hash) {
    const LIST_LIMIT = 300;

    let list = [];
    switch (hash) {
      case "#changelog":
        list = changelogIndex;
        break;
      case "#holes":
        list = holesIndex;
        break;
      case "#portals":
        list = portalsIndex;
        break;
      case "#achievements":
        list = achievementsIndex;
        break;
      case "#finish-args":
        list = finishArgsIndex;
        break;
      default: //"#apps":
        list = appsIndex;
        break;
    }

    // filter by current search
    const filtered = list.filter(it => it.count)
      .map(it => ({ ...it, hits: searchHits(search, it.tags) }))
      .filter(it => it.hits)
      .slice(0, LIST_LIMIT)

    const renderedList = filtered.map(({ count, displayURL, icon, name, title, hits, tags, details }) => {
      title = title ?? tags?.join("&#010;")
      details = details ?? hits?.filter(hit => !name.includes(hit)).join(", ")

      return `\
              <${displayURL ? "a" : "div"}
                class="row"
                href="${displayURL}"
                title="${title}"
                target="_blank"
              >
                <span class="left">${name}</span>
                <span class="middle">${details}</span>
                <span class="padding"></span>
                <span class="right">${count ? (count + ` ${icon}`) : ""}</span>
              </${ displayURL ? "a" : "div"} >
    `;
    })

    document.querySelector("main > ul").innerHTML = renderedList.join("");
    document.querySelector("footer").innerHTML = `Showing ${renderedList.length === LIST_LIMIT ? "max" : ""} ${renderedList.length} results`

    return;
  }

  // Generate a list of search hits
  function searchHits(search, tags) {
    if (search.trim() === "") {
      return tags;
    }

    const terms = search
      .toLowerCase()
      .split(" ")
      .map(it => it.trim())
      .filter(it => it !== "")


    if (terms.length === 0) {
      return tags;
    }

    const searchString = tags.join(" ").toLowerCase();
    const hit = terms.every(term => searchString.includes(term))
    if (!hit) {
      return null;
    }

    return tags.filter(tag => terms.some(term => tag.toLowerCase().includes(term)))
  }

</script>

</html>
