<!DOCTYPE html5>
<html>

<head>
  <meta charset="utf-8" />
  <title>Flatstat | Lists</title>
  <link rel="stylesheet" type="text/css" href="./index.css">
  </link>
</head>

<body>
  <header>
    <a href="/">
      <h1 id="title" title="Flatstat | Lists">flatstat</h1>
    </a>
    <nav>
      <a href="/" title="Lists" class="active">lists</a>
      <a href=/graphs/ title="Graphs">graphs</a>
      <a href="/library/" title="Library">library</a>
      <a href="/about/" title="About">about</a>
    </nav>
  </header>
  <main>
    <input id="search" value="" type="search" placeholder="Search for name">
    <nav>
      <a id="#apps" title="Apps sorted by Github stars" href="/#apps">🕹️ apps</a>
      <a id="#finish-args" title="Frequently used 'finish-args'" href=" /#finish-args">🏁 finish-args</a>
      <a id="#achievements" title="Apps sorted by achievements" href="/#achievements">🏅 achievements</a>
      <a id="#holes" title="Apps sorted by holes" href="/#holes">💥 holes</a>
      <a id="#portals" title="Apps sorted by well-known portals" href="/#portals">🕳️ portals</a>
    </nav>
    <ul>
    </ul>
  </main>
</body>
<script type="module">
  import {
    incrementAchievementCount,
    incrementHoleCount,
    incrementPortalCount,
    incrementFinishArgs,
    sumFinishArgs,
    sumAchievements,
    sumHoles,
    sumPortals
  } from "./lib/stats.js";
  import { useJSON } from "./lib/useJSON.js";
  import { useActiveLink } from "./lib/useActiveLink.js";
  import { useSearch } from "./lib/useSearch.js";

  let fetching = true;
  let count = [];
  let metafiles = [];

  useActiveLink("#apps")
  const input = useSearch("#search", (search) => renderList(search, window.location.hash))

  renderList(input.value, window.location.hash);
  window.addEventListener("hashchange", () => renderList(input.value, window.location.hash))

  // Map, filter, sort, slice, join list
  async function renderList(search, hash) {
    if (fetching) {
      count = await useJSON("./data/flathub/count.json")
      metafiles = await useJSON("./data/flathub/metafiles.json")
      fetching = false;
    }

    const ul = document.querySelector("ul")
    const LIST_LIMIT = 400;

    let list = [];
    switch (hash) {
      case "#holes":
        list = metafiles
          .filter(it => it.history[0]?.finishArgs)
          .map(it => {
            const holes = incrementHoleCount(it.history[0].finishArgs)
            const count = sumHoles(holes);

            return {
              count,
              displayURL: it.displayURL,
              icon: "💥",
              name: `${it.appID}.${it.ext}`,
              tags: [`${it.appID}.${it.ext}`, ...Object.keys(holes), `${count}`],
            }
          })
        break;
      case "#portals":
        list = metafiles
          .filter(it => it.history[0]?.finishArgs)
          .map(it => {
            const portals = incrementPortalCount(it.history[0].finishArgs)
            const count = sumPortals(portals);

            return {
              count,
              displayURL: it.displayURL,
              icon: "🕳️",
              name: `${it.appID}.${it.ext}`,
              tags: [`${it.appID}.${it.ext}`, ...Object.keys(portals), `${count}`],
            }
          })
        break;
      case "#achievements":
        list = metafiles
          .filter(it => it.history[0]?.finishArgs)
          .map(it => {
            const achievements = incrementAchievementCount(it.history[0].finishArgs);
            const count = sumAchievements(achievements);

            return {
              count,
              displayURL: it.displayURL,
              icon: "🏅",
              name: `${it.appID}.${it.ext}`,
              tags: [`${it.appID}.${it.ext}`, ...Object.keys(achievements), `${count}`],
            }
          })
        break;
      case "#finish-args":
        list = Object.entries(count[count.length - 1].finishArgs).map(([arg, count]) => ({
          count,
          displayURL: null,
          icon: "🏁",
          name: arg,
          tags: [arg, `${count}`],
          title: `${arg} - used by ${count} apps`,
        }))
        break;
      default: //"#stars":
        list = metafiles
          .map(it => {
            const finishArgs = incrementFinishArgs(it.history[0]?.finishArgs ?? [])

            return {
              count: it.stargazerCount,
              displayURL: it.displayURL,
              icon: "⭐",
              name: `${it.appID}.${it.ext}`,
              tags: [`${it.appID}.${it.ext}`, ...(finishArgs ? Object.keys(finishArgs) : []), `${it.stargazerCount}`],
            }
          })
        break;
    }

    const filtered = list.filter(it => it.count)
      // search
      .map(it => ({ ...it, hits: searchHits(search, it.tags) }))
      .filter(it => it.hits)
      .sort((a, b) => b.count - a.count)
      .slice(0, LIST_LIMIT)


    if (filtered.length === 0) {
      ul.innerHTML = "No results"
      return;
    }

    const renderedList = filtered.map(({ count, displayURL, icon, name, title, hits, tags }) => {
      title = title ?? tags?.join("&#010;")
      const details = hits?.filter(hit => hit !== name && isNaN(hit)).join(", ")

      return `\
        <${displayURL ? "a" : "div"}
          class="row"
          href="${displayURL}"
          title="${title}"
          target="_blank"
        >
          <span class="left">${name}</span>
          <span class="middle">${details}</span>
          <span class="padding"></span>
          <span>${count ? (count + ` ${icon}`) : ""}</span>
        </${displayURL ? "a" : "div"}>
    `;
    }).join("");

    ul.innerHTML = renderedList;
    return;
  }

  function searchHits(search, tags) {
    const terms = search
      .toLowerCase()
      .split(" ")
      .filter(it => it !== "")

    if (terms.length === 0) {
      return tags;
    }

    const searchString = tags.join(" ").toLowerCase();
    const hit = terms.every(term => searchString.includes(term))
    if (!hit) {
      return null;
    }

    return tags.filter(tag => terms.some(term => tag.toLowerCase().includes(term)))
  }

</script>

</html>
